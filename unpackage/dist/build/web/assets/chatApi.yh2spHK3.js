import{a4 as e,r as t,G as o,Z as a,a5 as n}from"./index-DwnOT4K7.js";import{r,b as s}from"./request.DtiC9qg0.js";import{u as l}from"./user.H6OceLeH.js";const c=e("chat",(()=>{const e=t([]),o=t(0),a=t(!1),n=t([]),r=t(new Map),s=()=>e.value&&e.value.length>0&&o.value>=0&&o.value<e.value.length?e.value[o.value].id:null;return{chatHistory:e,needFocusInput:a,chatIndex:o,chatMap:r,setChatMessages:(e,t)=>{const o=JSON.parse(JSON.stringify(t));r.value.set(e,o),e===s()&&(n.value=JSON.parse(JSON.stringify(o)))},getChatMessages:e=>{const t=r.value.get(e);return t?JSON.parse(JSON.stringify(t)):[]},addChatMessages:(e,t)=>{const o=[...r.value.get(e)||[],...t];r.value.set(e,o),console.log("添加消息后:",r.value.get(e)),e===s()&&(n.value=[...o])},currentMessages:n,setCurrentMessages:e=>{const t=r.value.get(e);n.value=t?JSON.parse(JSON.stringify(t)):[]},getCurrentChatId:s,clearChatMessages:e=>{r.value.delete(e)},clearAllChatMessages:()=>{r.value.clear(),n.value=[]}}})),i=(e,t,o,r)=>{try{const l=r.getChatMessages(t);if(!l||!l[o])return void console.error("未找到消息索引:",o,"聊天ID:",t);const c=[...l];"loading"===c[o].status&&(console.log("消息状态由loading变为incomplete，聊天ID:",t),c[o].status="incomplete");const i=(()=>{try{const e=a();return e.platform&&"ios"===e.platform.toLowerCase()}catch(e){return console.warn("检测iOS设备失败:",e),!1}})();let u=!1;if(e&&i)if(console.log("iOS设备处理响应块，聊天ID:",t),e.includes("```")||c[o].content.includes("```")){console.log("检测到可能是Markdown代码块，特殊处理");const t=c[o].content;if(e===t)return console.log("收到完全相同的内容，跳过更新"),void(u=!1);if(t.length>.9*e.length&&t.includes(e.substring(0,Math.floor(.9*e.length))))return console.log("已有内容包含新内容的大部分，可能是重复内容，跳过更新"),void(u=!1);if(e.length>t.length&&e.includes(t.substring(0,Math.floor(.9*t.length))))console.log("新内容包含已有内容且更长，使用新内容替换"),c[o].content=e,u=!0;else{const a=t+e;c[o].content=a,u=!0}}else e.length>c[o].content.length?(c[o].content=e,u=!0):-1===c[o].content.indexOf(e)&&(c[o].content+=e,u=!0);else e&&(c[o].content+=e,u=!0);if(u){console.log("更新聊天消息，聊天ID:",t),r.setChatMessages(t,c);try{n("chat:newContent",{messageIndex:o,currentChatId:t})}catch(s){console.error("尝试触发滚动事件失败:",s)}}}catch(l){console.error("处理数据块错误:",l)}},u=async(e,t,n,r)=>{const{currentChatId:u,messageIndex:d}=t,p=c(),h=l();let g=null;const f=()=>{try{let e;return e=a(),e.platform&&"ios"===e.platform.toLowerCase()}catch(e){return console.error("检测iOS设备失败:",e),!1}};try{if(console.log("开始流式请求，设备类型:",f()?"iOS":"其他"),console.log("请求数据:",e),f())return console.log("检测到iOS设备，使用uni.request处理请求"),new Promise(((t,a)=>{let l=!1;return o({url:`${s}/ai/askStream`,method:"POST",header:{Accept:"text/plain, text/html, */*","Content-Type":"application/x-www-form-urlencoded",Authorization:h.userInfo.authorization?`Bearer ${h.userInfo.authorization}`:""},data:{prompt:e.prompt||e,chatId:e.chatId||""},success:e=>{var o;if(!l)if(l=!0,console.log("uni.request完成，状态码:",e.statusCode),e.statusCode>=200&&e.statusCode<300)if(console.log("iOS请求成功完成"),e.data){console.log("iOS响应数据长度:","string"==typeof e.data?e.data.length:"non-string");const a=e.data;let r=[];if(a.includes("```")){console.log("检测到Markdown代码块，特殊处理分割");if((a.match(/```/g)||[]).length>2||a.includes("##")||(null==(o=a.match(/\n\n/g))?void 0:o.length)>3)console.log("检测到复杂Markdown文档，减少分割"),r.push(a);else{const e=a.split(new RegExp("(?<=\\n\\n)")).filter((e=>e.trim()));for(const t of e)if(t.includes("```"))r.push(t);else{const e=t.split(new RegExp("(?<=[。！？\\n])")).filter((e=>e.trim()));r.push(...e)}}}else r=a.split(new RegExp("(?<=[。！？\\n])")).filter((e=>e.trim()));let s=0,l="",c="";const h=()=>{if(s<r.length){const e=r[s],t=l+e;let o=!0;c===t&&(console.log("跳过完全重复的内容"),o=!1),l=t,e.trim()&&o&&(c=l,i(l,u,d,p)),s++,setTimeout(h,100)}else null==n||n(),t()};h()}else null==n||n(),t();else{console.error("请求失败，状态码:",e.statusCode,"响应:",e.data);const t=new Error(`HTTP错误: ${e.statusCode}`);null==r||r(t),a(t)}},fail:e=>{l||(l=!0,console.error("uni.request请求错误:",e),null==r||r(new Error("网络请求失败")),a(new Error("网络请求失败")))},complete:()=>{console.log("uni.request请求完成")}}),{cancel:()=>{l||(console.log("取消iOS请求"),l=!0)}}}));{let t;console.log("非iOS设备，使用标准fetch流式处理");let o="application/json";try{if("undefined"!=typeof FormData){const a=new FormData;a.append("prompt",e.prompt||e),a.append("chatId",e.chatId||""),e.files&&e.files.length>0?e.files.forEach((e=>{a.append("files",e)})):a.append("files",[]),t=a,o="multipart/form-data"}else t=JSON.stringify({prompt:e.prompt||e,chatId:e.chatId||""})}catch(m){console.warn("FormData创建失败，使用JSON格式:",m),t=JSON.stringify({prompt:e.prompt||e,chatId:e.chatId||""})}const a={Accept:"text/plain, text/html, */*",Authorization:h.userInfo.authorization?`Bearer ${h.userInfo.authorization}`:""};"application/json"===o&&(a["Content-Type"]=o);const r=await fetch(`${s}/ai/askStream`,{method:"POST",headers:a,body:t});if(console.log("fetch响应状态:",r.status,r.ok),!r.ok){const e=await r.text();throw console.error("fetch请求失败:",r.status,e),new Error(`HTTP error! status: ${r.status}`)}g=r.body.getReader();const l=new TextDecoder("utf-8");for(;;){const{done:e,value:t}=await g.read();if(e){console.log("fetch流式读取完成"),null==n||n();break}const o=l.decode(t,{stream:!0});console.log("fetch接收数据块:",o.length,"字符"),i(o,u,d,p)}return{cancel:()=>{g&&(console.log("取消fetch流式读取"),g.cancel(),g=null)}}}}catch(w){throw console.error("流式请求错误:",w),"AbortError"===w.name?null==r||r(new Error("传输已停止")):null==r||r(w),w}finally{g=null}},d={updRole:async e=>{let t;console.log("更新角色API被调用，参数:",e);let o="application/json";try{if("undefined"!=typeof FormData){if(t=new FormData,t.append("id",e.id),t.append("name",e.name),t.append("prompt",e.prompt),e.avatar){if(console.log("检测到头像文件:",e.avatar),!(e.avatar instanceof File||e.avatar instanceof Blob))return console.error("头像不是文件对象:",typeof e.avatar),Promise.reject(new Error("头像必须是文件对象"));console.log("添加文件对象到FormData, 文件名:",e.avatar.name||"未命名文件","大小:",e.avatar.size,"bytes"),t.append("avatar",e.avatar,e.avatar.name||`avatar_${Date.now()}.jpg`)}o="multipart/form-data"}else console.warn("FormData不可用，使用JSON格式发送请求"),t=JSON.stringify({id:e.id,name:e.name,prompt:e.prompt})}catch(n){console.warn("FormData创建失败，使用JSON格式:",n),t=JSON.stringify({id:e.id,name:e.name,prompt:e.prompt})}const a=l();console.log("准备发送请求, URL:",`${s}/ai/updRole`);try{const e={Authorization:a.userInfo.authorization?`Bearer ${a.userInfo.authorization}`:""};"application/json"===o&&(e["Content-Type"]=o);const n=await fetch(`${s}/ai/updRole`,{method:"POST",headers:e,body:t});if(!n.ok){const e=await n.text();throw console.error("API请求失败:",n.status,e),new Error(`HTTP error! status: ${n.status}`)}const r=await n.json();return console.log("API请求成功，返回结果:",r),r.data}catch(r){throw console.error("API请求异常:",r),r}},getRoles:async()=>(await r.get("/ai/roles")).data,createChat:async e=>(await r.post("/ai/create",e)).data,askStream:u,deleteChat:async e=>(await r.delete(`/ai/delChat/${e}`)).data,chatHistory:async()=>(await r.get("/ai/chatHistory")).data,chatMessages:async e=>{const t=(await r.get(`/ai/chatMessages/${e}`)).data;return console.log(t),t},createStreamRequest:(e,t={})=>{const{onChunk:n,onComplete:r,onError:c,onStart:i}=t,u=l();let d=null,p=!1,h=null,g=null;const f=()=>{try{let e;return e=a(),e.platform&&"ios"===e.platform.toLowerCase()}catch(e){return console.error("检测iOS设备失败:",e),!1}};return{start:async()=>{if(p)console.warn("流式请求已在进行中");else{p=!0,h=f()?null:new AbortController,null==i||i();try{let l;console.log("开始高级流式请求，设备类型:",f()?"iOS":"其他");let i="application/json";try{"undefined"!=typeof FormData?(l=new FormData,l.append("prompt",e.prompt||e),l.append("chatId",e.chatId||""),e.files&&e.files.length>0?e.files.forEach((e=>{l.append("files",e)})):l.append("files",""),i="multipart/form-data"):(console.warn("FormData不可用，使用JSON格式发送请求"),l=JSON.stringify({prompt:e.prompt||e,chatId:e.chatId||""}))}catch(t){console.warn("FormData创建失败，使用JSON格式:",t),l=JSON.stringify({prompt:e.prompt||e,chatId:e.chatId||""})}if(f()){console.log("检测到iOS设备，使用uni.request处理请求");try{o({url:`${s}/ai/askStream`,method:"POST",header:{Accept:"text/plain, text/html, */*","Content-Type":"application/x-www-form-urlencoded",Authorization:u.userInfo.authorization?`Bearer ${u.userInfo.authorization}`:""},data:{prompt:e.prompt||e,chatId:e.chatId||""},success:e=>{var t;if(p)if(console.log("uni.request完成，状态码:",e.statusCode),e.statusCode>=200&&e.statusCode<300)if(console.log("iOS请求成功完成"),e.data){console.log("iOS响应数据长度:","string"==typeof e.data?e.data.length:"non-string");const o=e.data;let a=[];if(o.includes("```")){console.log("检测到Markdown代码块，特殊处理分割");if((o.match(/```/g)||[]).length>2||o.includes("##")||(null==(t=o.match(/\n\n/g))?void 0:t.length)>3)console.log("检测到复杂Markdown文档，减少分割"),a.push(o);else{const e=o.split(new RegExp("(?<=\\n\\n)")).filter((e=>e.trim()));for(const t of e)if(t.includes("```"))a.push(t);else{const e=t.split(new RegExp("(?<=[。！？\\n])")).filter((e=>e.trim()));a.push(...e)}}}else a=o.split(new RegExp("(?<=[。！？\\n])")).filter((e=>e.trim()));let s=0,l="",c="";const i=()=>{if(s<a.length){const e=a[s],t=l+e;let o=!0;c===t&&(console.log("跳过完全重复的内容"),o=!1),l=t,e.trim()&&o&&(c=l,n(l,currentChatId,messageIndex,chatStore)),s++,setTimeout(i,100)}else null==r||r(),resolve()};i()}else null==r||r();else console.error("请求失败，状态码:",e.statusCode,"响应:",e.data),null==c||c(new Error(`HTTP错误: ${e.statusCode}`))},fail:e=>{p&&(console.error("uni.request请求错误:",e),null==c||c(new Error("网络请求失败")))},complete:()=>{console.log("uni.request请求完成"),p=!1,g=null}}),console.log("iOS uni.request已发送")}catch(a){console.error("发送uni.request请求失败:",a),null==c||c(a),p=!1,g=null}}else{console.log("非iOS设备，使用标准fetch流式处理");const e=await fetch(`${s}/ai/askStream`,{method:"POST",headers:{Accept:"text/plain, text/html, */*",Authorization:u.userInfo.authorization?`Bearer ${u.userInfo.authorization}`:""},body:l,signal:h.signal});if(console.log("fetch响应状态:",e.status,e.ok),!e.ok){const t=await e.text();throw console.error("fetch请求失败:",e.status,t),new Error(`HTTP error! status: ${e.status}`)}d=e.body.getReader();const t=new TextDecoder("utf-8");for(;p&&!h.signal.aborted;){const{done:e,value:o}=await d.read();if(e){console.log("fetch高级流式读取完成"),null==r||r();break}const a=t.decode(o,{stream:!0});console.log("fetch高级接收数据块:",a.length,"字符"),null==n||n(a)}}}catch(l){console.error("流式传输错误:",l),"AbortError"===l.name?console.log("传输已停止"):null==c||c(l)}finally{p=!1,d=null,h=null}}},cancel:()=>{f()&&g?(console.log("取消iOS高级XHR请求"),g.abort(),g=null):(h&&(console.log("取消fetch高级流式读取"),h.abort()),d&&d.cancel()),p=!1,d=null,h=null},isActive:()=>p}},askStreamWithChat:async(e,t,o,a,n)=>{const r=c(),s={currentChatId:t,messageIndex:r.currentMessages?r.currentMessages.length-1:0};return await u({prompt:e,chatId:t},s,a,n)},editChat:async e=>(await r.post("/ai/updChat",e)).data,deleteRole:async e=>{console.log("删除角色API被调用，角色ID:",e);return(await r.delete(`/ai/delRole/${e}`)).data}};export{d as c,c as u};
