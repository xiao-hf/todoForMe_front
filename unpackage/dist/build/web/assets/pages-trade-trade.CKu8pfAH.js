import{r as e,a8 as a,p as l,Q as t,o as s,a as o,c as u,w as n,i as c,b as i,g as r,d,e as f,n as v,t as m,u as p,v as _,F as g,f as h,J as y,s as b,y as k,z as C,C as w,j as x,k as N,I as M,S as P,l as V,x as z,h as I}from"./index-DwnOT4K7.js";import{r as F,_ as j}from"./uni-app.es.BBfL1HZQ.js";import{u as T,t as X}from"./constants.CkXuN2aH.js";import{u as R}from"./user.H6OceLeH.js";import{_ as U}from"./_plugin-vue_export-helper.BCo6x5W8.js";import"./request.DtiC9qg0.js";const q=U({__name:"trade",setup(U){const q=R(),D=T(),$=e(!1),G=e(!1),L=e([]),E=e(0),Y=e({}),A=e(0),J=e(0),O=e(null),Q=a({name:"",code:""}),S=e(!1),B=e(!1),H=e(!1),K=e({id:null,name:"",code:"",singleProfit:""}),W=e(!1),Z=e(!1),ee=e({}),ae=e(!1),le=e("default"),te=[{value:"default",label:"默认"},{value:"profit",label:"盈亏"},{value:"winRate",label:"胜率"},{value:"profitRatio",label:"盈亏比"}],se=e([]),oe=l((()=>q.userInfo.backgroudImg||"")),ue=l((()=>E.value>0?"+"+E.value.toFixed(2):E.value.toFixed(2))),ne=l((()=>{const e=te.find((e=>e.value===le.value));return e?e.label.replace("（从高到低）",""):"盈亏"})),ce=()=>{y()},ie=()=>{var e,a;console.log("开始搜索, 搜索参数:",Q),(null==(e=Q.name)?void 0:e.trim())||(null==(a=Q.code)?void 0:a.trim())?b({title:"搜索中...",icon:"loading",duration:1e3}):b({title:"加载全部数据...",icon:"loading",duration:1e3}),xe()},re=()=>{var e,a;(null==(e=Q.name)?void 0:e.trim())||(null==(a=Q.code)?void 0:a.trim())||(console.log("搜索框为空，显示所有数据"),xe())},de=e=>{Y.value[e]&&(Y.value[e].translateX=0,Y.value[e].showDelete=!1)},fe=()=>{Object.keys(Y.value).forEach((e=>{de(e)}))},ve=e=>{const a=Number(e.winMoney||0)-Number(e.lostMoney||0);return a>=0?"+"+a.toFixed(2):a.toFixed(2)},me=e=>{const a=Number(e.winMoney||0)-Number(e.lostMoney||0);return a>0?"positive":a<0?"negative":""},pe=e=>{const a=Number(e.winCount||0),l=a+Number(e.lostCount||0);if(0===l)return"0.00%";return(a/l*100).toFixed(2)+"%"},_e=e=>{const a=Math.abs(Number(e.winMoney||0)),l=Math.abs(Number(e.lostMoney||0));if(0===l)return 0===a?"0":"∞";return(a/l).toFixed(2)},ge=()=>{Z.value=!0,setTimeout((()=>{W.value=!1,Z.value=!1,ee.value={}}),300)},he=()=>{ae.value=!ae.value},ye=()=>{if(!L.value||0===L.value.length)return;if("default"===le.value)return void(se.value.length>0&&(L.value=[...se.value],console.log("恢复默认排序（后端返回顺序）")));const e=[...L.value].sort(((e,a)=>{switch(le.value){case"profit":const l=Number(e.winMoney||0)-Number(e.lostMoney||0);return Number(a.winMoney||0)-Number(a.lostMoney||0)-l;case"winRate":const t=be(e);return be(a)-t;case"profitRatio":const s=ke(e);return ke(a)-s;default:return 0}}));L.value=e,console.log(`按${ne.value}排序完成`)},be=e=>{const a=Number(e.winCount||0),l=a+Number(e.lostCount||0);return 0===l?0:a/l*100},ke=e=>{const a=Math.abs(Number(e.winMoney||0)),l=Math.abs(Number(e.lostMoney||0));return 0===l?0===a?0:999999:a/l};async function Ce(){try{const e=await X.queryProfit({});200===e.code||"200"===e.code?E.value=Number(e.data||0):console.error("获取总盈亏数据失败:",e.message)}catch(e){console.error("获取总盈亏数据异常:",e),E.value=0}}const we=e([]);async function xe(){var e,a;try{const l={name:(null==(e=Q.name)?void 0:e.trim())||"",code:(null==(a=Q.code)?void 0:a.trim())||""};console.log("搜索参数:",l);const t=!l.name&&!l.code,s=await X.queryGoods(t?{}:l);if(console.log("API返回结果:",s),200===s.code||"200"===s.code){const e=s.data||[];if(t)we.value=e,L.value=e,se.value=[...e],console.log("加载全部商品列表:",e.length,"条记录");else if(0===e.length&&we.value.length>0){console.log("后端搜索无结果，尝试前端过滤");const e=we.value.filter((e=>{const a=!l.name||e.name&&e.name.toLowerCase().includes(l.name.toLowerCase()),t=!l.code||e.code&&e.code.toLowerCase().includes(l.code.toLowerCase());return a&&t}));L.value=e,se.value=[...e],console.log("前端过滤结果:",e.length,"条记录")}else L.value=e,se.value=[...e],console.log("后端搜索结果:",e.length,"条记录");L.value.length>0&&"default"!==le.value&&ye()}else console.error("获取商品列表失败:",s.message)}catch(l){console.error("获取商品列表异常:",l)}}const Ne=()=>{H.value=!1,K.value={id:null,name:"",code:"",singleProfit:""},S.value=!0},Me=e=>{H.value=!0,K.value={id:e.id,name:e.name||"",code:e.code||"",singleProfit:e.singleProfit||""},S.value=!0,W.value&&ge()},Pe=()=>{B.value=!0,setTimeout((()=>{S.value=!1,B.value=!1}),300)},Ve=async()=>{if(!K.value.name.trim())return void b({title:"品种名称必填",icon:"none"});if(!K.value.code.trim())return void b({title:"品种代码必填",icon:"none"});if(!K.value.singleProfit.trim())return void b({title:"1手1点利润必填",icon:"none"});const e=parseFloat(K.value.singleProfit);if(isNaN(e)||e<=0)b({title:"请输入有效的1手1点利润",icon:"none"});else{k({title:H.value?"保存中...":"添加中..."});try{const a={...K.value,singleProfit:e},l=H.value?await X.updGoods(a):await X.addGoods(a);C(),200===l.code||"200"===l.code?(b({title:H.value?"保存成功":"添加成功",icon:"success"}),Pe(),xe()):b({title:l.message||"操作失败",icon:"none"})}catch(a){C(),b({title:"操作失败",icon:"none"}),console.error("保存商品失败:",a)}}},ze=e=>{fe(),w({title:"删除确认",content:`确定要删除"${e.name||"未命名品种"}"吗？`,confirmColor:"#f56c6c",success:async a=>{a.confirm&&(await Ie(e.id),W.value&&ge())}})},Ie=async e=>{if(e){k({title:"删除中..."});try{const a=await X.delGoods(e);C(),200===a.code||"200"===a.code?(b({title:"删除成功",icon:"success"}),xe()):b({title:a.message||"删除失败",icon:"none"})}catch(a){C(),b({title:"删除失败",icon:"none"}),console.error("删除商品失败:",a)}}},Fe=async()=>{G.value=!0,fe();try{await(async()=>{try{await Promise.all([Ce(),xe()]),b({title:"刷新成功",icon:"success",duration:1500})}catch(e){console.error("刷新数据失败:",e),b({title:"刷新失败",icon:"none",duration:2e3})}})()}catch(e){console.error("下拉刷新失败:",e)}finally{setTimeout((()=>{G.value=!1}),1e3)}},je=()=>{$.value=!0,b({title:"背景图片加载失败",icon:"none"})},Te=()=>{$.value=!1};t((()=>D.needRefreshGoods),(async e=>{if(e){console.log("检测到需要刷新商品数据，开始刷新...",e);try{await Promise.all([Ce(),xe()]),console.log("商品数据刷新完成")}catch(a){console.error("刷新商品数据失败:",a)}}}));const Xe=()=>{ae.value&&(ae.value=!1)};return s((async()=>{q.initUserInfo();try{await Promise.all([Ce(),xe()])}catch(e){console.error("加载数据失败:",e)}})),(e,a)=>{const l=x,t=F(o("uni-icons"),j),s=c,y=N,b=M,k=P,C=V;return i(),u(s,{class:"trade-container"},{default:n((()=>[oe.value?(i(),u(l,{key:0,src:oe.value,class:"background-image",mode:"aspectFill",onError:je,onLoad:Te},null,8,["src"])):r("",!0),d(s,{class:"nav-header"},{default:n((()=>[d(s,{class:"nav-left"},{default:n((()=>[d(s,{class:"icon-wrapper",onClick:ce},{default:n((()=>[d(t,{type:"back",size:"24",color:"#fff"})])),_:1})])),_:1}),d(s,{class:"nav-center"},{default:n((()=>[d(y,{class:"profit-text"},{default:n((()=>[f(" 总盈亏: "),d(y,{class:v(["profit-number",{"profit-positive":E.value>0,"profit-negative":E.value<0}])},{default:n((()=>[f(m(ue.value),1)])),_:1},8,["class"])])),_:1})])),_:1}),d(s,{class:"nav-right"})])),_:1}),d(s,{class:"search-area"},{default:n((()=>[d(s,{class:"search-box"},{default:n((()=>[d(s,{class:"sort-btn-container"},{default:n((()=>[d(s,{class:"sort-btn",onClick:he},{default:n((()=>[d(t,{type:"list",size:"18",color:"#667eea"}),d(y,{class:"sort-text"},{default:n((()=>[f(m(ne.value),1)])),_:1}),d(t,{type:ae.value?"up":"down",size:"14",color:"#667eea"},null,8,["type"])])),_:1}),ae.value?(i(),u(s,{key:0,class:"sort-dropdown"},{default:n((()=>[(i(),p(g,null,_(te,((e,a)=>d(s,{class:v(["sort-option",{active:le.value===e.value}]),key:a,onClick:a=>(e=>{le.value=e.value,ye(),ae.value=!1})(e)},{default:n((()=>[d(y,{class:"option-text"},{default:n((()=>[f(m(e.label),1)])),_:2},1024),le.value===e.value?(i(),u(s,{key:0,class:"option-check"},{default:n((()=>[d(t,{type:"checkmarkempty",size:"16",color:"#667eea"})])),_:1})):r("",!0)])),_:2},1032,["class","onClick"]))),64))])),_:1})):r("",!0)])),_:1}),d(s,{class:"search-input-wrapper"},{default:n((()=>[d(b,{class:"search-input",type:"text",modelValue:Q.name,"onUpdate:modelValue":a[0]||(a[0]=e=>Q.name=e),placeholder:"品种名称","confirm-type":"search",onConfirm:ie,onInput:re},null,8,["modelValue"])])),_:1}),d(s,{class:"search-input-wrapper"},{default:n((()=>[d(b,{class:"search-input",type:"text",modelValue:Q.code,"onUpdate:modelValue":a[1]||(a[1]=e=>Q.code=e),placeholder:"品种代码","confirm-type":"search",onConfirm:ie,onInput:re},null,8,["modelValue"])])),_:1}),d(s,{class:"search-btn",onClick:ie},{default:n((()=>[d(t,{type:"search",size:"18",color:"#667eea"})])),_:1})])),_:1})])),_:1}),d(s,{class:"trade-content",onClick:Xe},{default:n((()=>[d(k,{class:"market-list","scroll-y":"true","refresher-enabled":"true","refresher-background":"transparent","refresher-triggered":G.value,onRefresherrefresh:Fe},{default:n((()=>[L.value.length>0?(i(),u(s,{key:0,class:"goods-list"},{default:n((()=>[(i(!0),p(g,null,_(L.value,((e,a)=>(i(),u(s,{class:"goods-swipe-container",key:e.id},{default:n((()=>[d(s,{class:"goods-swipe-wrapper"},{default:n((()=>{var a,l;return[d(s,{class:"goods-item",style:z({transform:`translateX(${(null==(a=Y.value[e.id])?void 0:a.translateX)||0}rpx)`}),onTouchstart:a=>{return l=a,t=e.id,A.value=l.touches[0].clientX,J.value=l.touches[0].clientY,void(O.value=t);var l,t},onTouchmove:a=>((e,a)=>{if(O.value!==a)return;const l=e.touches[0].clientX,t=e.touches[0].clientY,s=l-A.value,o=t-J.value;if(!(Math.abs(o)>Math.abs(s))&&s<0){const e=Math.max(.5*s,-120);Y.value[a]||(Y.value[a]={}),Y.value[a].translateX=e,Y.value[a].showDelete=e<-30}})(a,e.id),onTouchend:a=>((e,a)=>{if(O.value!==a)return;const l=Y.value[a];l&&(l.translateX<-60||l.translateX<-30?(l.translateX=-120,l.showDelete=!0):de(a),O.value=null)})(0,e.id),onClick:a=>(e=>{fe(),I({url:`/pages/logDetail/logDetail?goodsId=${e.id}&goodsName=${encodeURIComponent(e.name||"未命名")}&goodsCode=${encodeURIComponent(e.code||"")}`})})(e)},{default:n((()=>[d(s,{class:"goods-row"},{default:n((()=>[d(s,{class:"goods-name-col"},{default:n((()=>[d(y,{class:"goods-name"},{default:n((()=>[f(m(e.name||"未命名"),1)])),_:2},1024),d(y,{class:"goods-code"},{default:n((()=>[f(m(e.code||"-"),1)])),_:2},1024)])),_:2},1024),d(s,{class:"goods-stats-col1"},{default:n((()=>[d(s,{class:"stats-item"},{default:n((()=>[d(y,{class:"stats-label"},{default:n((()=>[f("盈亏:")])),_:1}),d(y,{class:v(["stats-value",me(e)])},{default:n((()=>[f(m(ve(e)),1)])),_:2},1032,["class"])])),_:2},1024),d(s,{class:"stats-item"},{default:n((()=>[d(y,{class:"stats-label"},{default:n((()=>[f("胜率:")])),_:1}),d(y,{class:"stats-value"},{default:n((()=>[f(m(pe(e)),1)])),_:2},1024)])),_:2},1024)])),_:2},1024),d(s,{class:"goods-stats-col2"},{default:n((()=>[d(s,{class:"stats-item"},{default:n((()=>[d(y,{class:"stats-label"},{default:n((()=>[f("盈亏比:")])),_:1}),d(y,{class:"stats-value"},{default:n((()=>[f(m(_e(e)),1)])),_:2},1024)])),_:2},1024),d(s,{class:"stats-item"},{default:n((()=>[d(y,{class:"stats-label"},{default:n((()=>[f("利润:")])),_:1}),d(y,{class:"stats-value"},{default:n((()=>{return[f(m((a=e.singleProfit,isNaN(a)||""===a?"0.0":a.toFixed(1)))+"/点/手",1)];var a})),_:2},1024)])),_:2},1024)])),_:2},1024),d(s,{class:"edit-icon",onClick:h((a=>Me(e)),["stop"])},{default:n((()=>[d(t,{type:"compose",size:"22",color:"#667eea"})])),_:2},1032,["onClick"])])),_:2},1024)])),_:2},1032,["style","onTouchstart","onTouchmove","onTouchend","onClick"]),(null==(l=Y.value[e.id])?void 0:l.showDelete)?(i(),u(s,{key:0,class:"delete-action",onClick:a=>ze(e)},{default:n((()=>[d(t,{type:"trash",size:"24",color:"#fff"})])),_:2},1032,["onClick"])):r("",!0)]})),_:2},1024)])),_:2},1024)))),128))])),_:1})):(i(),u(s,{key:1,class:"empty-state"},{default:n((()=>[d(y,{class:"empty-text"},{default:n((()=>[f("暂无交易品种")])),_:1}),d(y,{class:"empty-tips"},{default:n((()=>[f('点击下方"+"添加交易品种')])),_:1})])),_:1}))])),_:1},8,["refresher-triggered"])])),_:1}),S.value?(i(),u(s,{key:1,class:"modal-overlay",onClick:Pe},{default:n((()=>[d(s,{class:v(["modal-content",{closing:B.value}]),onClick:a[5]||(a[5]=h((()=>{}),["stop"]))},{default:n((()=>[d(s,{class:"popup-header"},{default:n((()=>[d(y,{class:"popup-title"},{default:n((()=>[f(m(H.value?"编辑品种":"添加品种"),1)])),_:1}),d(s,{class:"popup-close",onClick:Pe},{default:n((()=>[d(t,{type:"close",size:"20",color:"#666"})])),_:1})])),_:1}),d(s,{class:"input-group"},{default:n((()=>[d(s,{class:"input-label"},{default:n((()=>[d(y,{class:"required"},{default:n((()=>[f("*")])),_:1}),f("品种名称 ")])),_:1}),d(b,{class:"goods-input",modelValue:K.value.name,"onUpdate:modelValue":a[2]||(a[2]=e=>K.value.name=e),placeholder:"请输入品种名称",maxlength:"50"},null,8,["modelValue"])])),_:1}),d(s,{class:"input-group"},{default:n((()=>[d(s,{class:"input-label"},{default:n((()=>[d(y,{class:"required"},{default:n((()=>[f("*")])),_:1}),f("品种代码 ")])),_:1}),d(b,{class:"goods-input",modelValue:K.value.code,"onUpdate:modelValue":a[3]||(a[3]=e=>K.value.code=e),placeholder:"请输入品种代码",maxlength:"20"},null,8,["modelValue"])])),_:1}),d(s,{class:"input-group"},{default:n((()=>[d(s,{class:"input-label"},{default:n((()=>[d(y,{class:"required"},{default:n((()=>[f("*")])),_:1}),f("1手1点利润 ")])),_:1}),d(b,{class:"goods-input",type:"digit",modelValue:K.value.singleProfit,"onUpdate:modelValue":a[4]||(a[4]=e=>K.value.singleProfit=e),placeholder:"请输入1手1点利润",maxlength:"20"},null,8,["modelValue"])])),_:1}),d(s,{class:"popup-actions"},{default:n((()=>[d(C,{class:"cancel-btn",onClick:Pe},{default:n((()=>[f("取消")])),_:1}),d(C,{class:"confirm-btn",onClick:Ve,disabled:!K.value.name||!K.value.code||!K.value.singleProfit},{default:n((()=>[f(m(H.value?"保存":"添加"),1)])),_:1},8,["disabled"])])),_:1})])),_:1},8,["class"])])),_:1})):r("",!0),d(s,{class:"add-goods-container"},{default:n((()=>[d(s,{class:"add-goods-btn",onClick:Ne},{default:n((()=>[d(t,{type:"plus",size:"20",color:"#fff"}),d(y,{class:"add-btn-text"},{default:n((()=>[f("添加品种")])),_:1})])),_:1})])),_:1}),W.value?(i(),u(s,{key:2,class:"modal-overlay",onClick:ge},{default:n((()=>[d(s,{class:v(["modal-content detail-modal",{closing:Z.value}]),onClick:a[8]||(a[8]=h((()=>{}),["stop"]))},{default:n((()=>[d(s,{class:"popup-header"},{default:n((()=>[d(y,{class:"popup-title"},{default:n((()=>[f("品种详情")])),_:1}),d(s,{class:"popup-close",onClick:ge},{default:n((()=>[d(t,{type:"close",size:"20",color:"#666"})])),_:1})])),_:1}),d(s,{class:"detail-content"},{default:n((()=>[d(s,{class:"detail-item"},{default:n((()=>[d(y,{class:"detail-label"},{default:n((()=>[f("品种名称")])),_:1}),d(y,{class:"detail-value"},{default:n((()=>[f(m(ee.value.name||"未命名"),1)])),_:1})])),_:1}),d(s,{class:"detail-item"},{default:n((()=>[d(y,{class:"detail-label"},{default:n((()=>[f("品种代码")])),_:1}),d(y,{class:"detail-value"},{default:n((()=>[f(m(ee.value.code||"-"),1)])),_:1})])),_:1}),d(s,{class:"detail-item"},{default:n((()=>[d(y,{class:"detail-label"},{default:n((()=>[f("当前价格")])),_:1}),d(y,{class:"detail-value"},{default:n((()=>[f("¥"+m(e.formatPrice(ee.value.price)),1)])),_:1})])),_:1}),d(s,{class:"detail-item"},{default:n((()=>[d(y,{class:"detail-label"},{default:n((()=>[f("涨跌幅")])),_:1}),d(y,{class:v(["detail-value",e.getChangeClass(ee.value.change)])},{default:n((()=>[f(m(e.formatChange(ee.value.change)),1)])),_:1},8,["class"])])),_:1}),d(s,{class:"detail-item"},{default:n((()=>[d(y,{class:"detail-label"},{default:n((()=>[f("库存")])),_:1}),d(y,{class:"detail-value"},{default:n((()=>[f(m(ee.value.stock||0),1)])),_:1})])),_:1})])),_:1}),d(s,{class:"popup-actions"},{default:n((()=>[d(C,{class:"action-btn edit",onClick:a[6]||(a[6]=e=>Me(ee.value))},{default:n((()=>[f("编辑")])),_:1}),d(C,{class:"action-btn delete",onClick:a[7]||(a[7]=e=>ze(ee.value))},{default:n((()=>[f("删除")])),_:1})])),_:1})])),_:1},8,["class"])])),_:1})):r("",!0)])),_:1})}}},[["__scopeId","data-v-48f790de"]]);export{q as default};
